% !TEX root = main.tex
\chapter{Analysis}

This chapter will describe how the BWIM system performs. What works? Why? How? etc.
The main focus should perhaps be placed on identifying the pros and cons of the matrix method and optimization method.

Should include:
\begin{easylist}[itemize]
& Compare theoretical and calculated influence lines. Also include influence lines found through Abaqus.
& Check how influence lines found through matrix method and optimization reproduces the strain history
& Test obtained influence line by running the bwim routine on the hitherto unused freight train. (Depends on getting info about the train). Also Do this test on the other trains.
\end{easylist}
Lerelva bridge has ben a subject of several phd students at NTNU and because of this there exist a accurate Abaqus model of the bridge. Two other student had master projects similar to mine, and I was lucky enough to "borrow" a influence line from them.
\begin{figure}[H]
	\begin{adjustbox}{center}
		\input{tikz/influenceLinesAbaqus.tex}
	\end{adjustbox}
	\caption{Influence line generated by abaqus}
	\label{fig:inflAbaqus}
\end{figure}

\input{strainAnalysis}

\section{Finding the speed of the train}
The importance of using the correct speed in a BWIM system becomes apparent when calculating influence line for a sensor. A wrongly determined speed will result in what looks like dynamic effects or an oscillating influence line, none of which should appear in a static influence line. If the influence line is known incorrect train velocities will still cause wrongly calculated axle weights. A correctly calculated speed is therefore of utmost importance for Bridge Weigh-in-Motion.
As discussed in theory there are two ways used by existing BWIM systems to find the train's velocity. Both these methods have been implemented and tested, however they contained flaws making them unreliable, or unsuitable for this project.
% \Activate
\begin{easylist}[itemize]
 & The method of peak identification \ref{section:trainSpeed}, is very subjected to noise corrupting location of identified peaks. A train undercarriage typically consist of axles in pairs or threes, which will all influence the sensors simultaneously creating a major peak containing smaller peaks. In such a case the identification of a single peak can be difficult, and will likely provide faulty calculated velocity.
 & The method of phase difference using cross correlation depends on strain signals where the trains velocities are known and the distance between two or more sensors. This method seems to work independently of noise which likely makes it superior to the peak method. This method will however require calibration for each setup of a BWIM system, due to it requirering a system constant depending on the bridge and sensor placement. The velocity of the trains producing the strain signals in this thesis, was not known or attainable through NSB or Jernbaneverket and therefore this method were not applicable for this project.
\end{easylist}
% \Deactivate
These two methods both work very well for a theoretical signal, however when noise and dynamics are introduced as well as more complicated bridge boundary conditions identifying the peaks representing the same axles becomes complex. A method indentifying peaks, will have to adapt to each signal because the magnitude of noise and dynamics vary for the different sensors and train passings. Due to this thesis' focus on the matrix method and influence lines, these methods have not been a priority and since correct train velocities are of utmost importance for calculating influence lines.

Since neither of these methods were usable without calibration, an alternative way was developed. This method determined the velocity by recreating the strain signal, like shown in equation  \ref{fig:recreated_strains}, for various train velocities and minimizing the difference between measured and recreated signal. It utilizes equation \ref{equation:moses_expanded} and requires constant values of axle weights as well as known axle spacings. The only varying factor is the speed used in each iteration to calculate an influence line. A well suited Matlab function "fminsearch", was used to search for the optimal value of train velocity. "fminsearch finds the minimum of a scalar function of several variables, starting at an initial estimate. This is generally referred to as unconstrained nonlinear optimization." This method uses brute force, and its time consumption proved high. The accuracy of this methods seem reliable due to

The velocities of the trains found through this brute force method is shown in table \ref{table:speeds}, and all plots and results produced have been made using these velocities, except for specificly mentioned cases.
\begin{table}[h]
	\centering
	\begin{tabularx}{\textwidth}{ |X|X|X|X|X|X| }
		\hline
		train & 3 & 4 & 5 & 6 & 8 \\
		\hline
		velocity [\SI{}{\meter\per\second}] & 20.99 & 21.7276	&21.4857 & 16.83 &	20.591465  \\
		\hline
	\end{tabularx}
	\caption{Table of determined train velocities}
	\label{table:speeds}
\end{table}


\input{analysisMatrixMethod}

\section{Optimized influence lines}
Perform the same procedures as for the matrix method

\section{Differences between the methods}
Compare the optimized influence lines and the matrix method influence lines. This should be done in a thorough manner.
\section{Problems}
\begin{easylist}[itemize]
& Big problem with identifying exactly when train enters and leaves the bridge. This results in guesswork when placing influence line in a coordinate system. Where does the bridge begin and end in the influence line.. The only definite certainty seems to be placing the index of the maximum magnitude of the influence line in the correct position according to the measuring sensor's location.
& This could be problematic when using the found influence lines
& These problems have been reduced, now the biggest problem is placing the peak of the influence line as well as possible. Possibly performing a smoothing and then finding position of peak could give a better estimate of sensorloc at influence line.. currently the max value of influence line is placed at sensorloc.
\end{easylist}





\input{calculatingAxleWeights}
% \subsubsection{Calculate the axle weights}
% The axle weights used to calculate the influence lines are as in table \ref{table:axle_weights}. These are as discussed in chapter method something!!. The system setup described in section \ref{system_setup}, gives us three different locaions for measuring strain and so we have three diffferent influence lines generated by the BWIM program. When calculating the axle weights corresponding to each train, we will then have three different estimates of the axle weights.
%
% \begin{figure}[h]
% 	\begin{subfigure}[t]{0.3\textwidth}
% 		\input{tikz/influenceLines/averagedInfluenceline_sensor1.tex}
% 		\caption{sensor 1}
% 		\label{fig:sensor1}
% 	\end{subfigure}
% 	\begin{subfigure}[t]{0.3\textwidth}
% 		\input{tikz/influenceLines/averagedInfluenceline_sensor2.tex}
% 		\caption{sensor 1}
% 		\label{fig:sensor1}
% 	\end{subfigure}
% 	\begin{subfigure}[t]{0.3\textwidth}
% 		\input{tikz/influenceLines/averagedInfluenceline_sensor3.tex}
% 		\caption{sensor 1}
% 		\label{fig:sensor1}
% 	\end{subfigure}
% 	\caption{averaged filtered influence lines used to calculate axle weights}
% 	\label{averaged_filtered_infl_lines}
% \end{figure}
%
%
% \begin{table}[h]
% 	\centering
% 	\begin{tabularx}{\textwidth}{ |X|X|X|X|X|X|X|X|X| }
% 		\hline
% 		Axle & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\
% 		\hline
% 		Axle weight [\SI{}{\kg}] & 9500 &	9500 & 9500 &	9500 & 14575 & 14575 & 14575 & 14575 \\
% 		\hline
% 	\end{tabularx}
% 	\caption{Table of axle weights used to perform BWIM}
% 	\label{table:axle_weights}
% \end{table}
%
% \begin{table}[h]
% 	\centering
% 	\begin{tabularx}{\textwidth}{@{\extracolsep{\fill} } |X|X|X|X|X|X|X|X|X| }
% 		\hline
% 		Axle & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\
% 		\hline
% 		Train 3: axle weight [\SI{}{\kg}] & 12961 &	2650 & 12627 &	3185 & 19950 & 4529 & 18450 & 4474 \\
% 		\hline
% 		Train 4: axle weight [\SI{}{\kg}] & 11772 &	8569 & 1112 &	8404 & 16646 & 13129 & 15673 & 11894 \\
% 		\hline
% 		Train 6: axle weight [\SI{}{\kg}] & 12861 &	7306 & 12663 &	7717 & 18694 & 11667 & 17822 & 9619 \\
% 		\hline
% 		Train 8: axle weight [\SI{}{\kg}] &  12172 &	8042 & 11774 &	8271 & 17076 & 13411 & 16356 & 11823 \\
% 		\hline
% 	\end{tabularx}
% \end{table}
%
% \begin{table}[h]
% 	\centering
% 	\begin{tabularx}{\textwidth}{@{\extracolsep{\fill} } |X|X|X|X|X|X|X|X|X|X|X|X|X| }
% 		\hline
% 		 & \multicolumn{3}{ |c| }{Train 3} & \multicolumn{3}{ |c| }{Train 4} & \multicolumn{3}{ |c| }{Train 6} & \multicolumn{3}{ |c| }{Train 8}\\
% 		\hline
% 		Axle\textbackslash sensor & 1 & 2 & 3 & 1 & 2 & 3 & 1 & 2 & 3 &  1 & 2 & 3 \\
% 		\hline
% 		1 [\SI{}{\kg}] & 8295 & 5875 & 6654 & 10543 & 7839 & 7212 & 10783 & 8004 &  6933 & 10336 & 7831 & 6869 \\
% 		\hline
% 		2 [\SI{}{\kg}] & 9243 & 6849 & 5614 & 10132 & 7413 & 5727 & 10206 & 7095 & 6691 & 10276 & 7323 & 6128 \\
% 		\hline
% 		3 [\SI{}{\kg}] & 8492 & 6579 & 6947 & 9897 & 8076 & 6810 & 10849 & 8631 & 6731 & 9808 & 8122 & 6452 \\
% 		\hline
% 		4 [\SI{}{\kg}] & 8715 & 6543 & 4546 & 9714 & 6740 & 4984 & 10432 & 7100 & 6136 & 10300 & 7182 & 5729 \\
% 		\hline
% 		car sum [\SI{}{\kg}] & 34745 & 25846 & 23761 & 40286 & 30068 & 24733 & 42270 & 30830 & 26491 & 40720 & 30458 & 25178 \\
% 		\hline
% 		5 [\SI{}{\kg}] & 13072 & 10066 & 10160 & 14897 & 12600 & 10002 & 15304 & 12323 & 9913 & 14015 & 11726 & 9192 \\
% 		\hline
% 		6 [\SI{}{\kg}] & 14405 & 11204 & 9846 & 15188 & 11800 & 9948 & 15921 & 11582 & 11275 & 16679 & 12526 & 11617 \\
% 		\hline
% 		7 [\SI{}{\kg}] & 10936 & 8733 & 9729 & 13860 & 11751 & 10319 & 15118 & 12554 &10376 & 13356 & 11569 & 9490 \\
% 		\hline
% 		8 [\SI{}{\kg}] & 14073 & 10897 & 8877 & 13801 & 10476 & 8624 & 13608 & 9730 & 9401 & 14910 & 11179 & 9878 \\
% 		\hline
% 		Loc sum [\SI{}{\kg}] & 52486  & 40900 & 38612 & 57746 & 46627 & 38893 & 59951 & 46189 & 40965 & 58960 & 47000 & 40177 \\
% 		\hline
% 		tot sum [\SI{}{\kg}] & 87231 & 66746 & 62374 & 98031 & 76695 & 63625 & 102221 & 77019 & 67457 & 99680 & 77457 & 65355 \\
% 		\hline
% 	\end{tabularx}
% \end{table}
%
% As table \ref{table:axleWeights_elongated} shows, there clearly is some error in the calculated axle weights. Especially sensor 2 and 3 which generally gives very low estimates. This trend hold for minimal and extended influence lines as well which means that the sensors have not been calibrated. By looking at the same measurement for a specific axle for one sensor and comparing with the same calculated axle weight for another sensor it is possible to calculate the ratio between them. If this ratio also holds for the other axles, the relationship between sensor 1 and 2 is almost constant which in the authors opinion shows the uncalibrated nature of the sensors.
% If at least one trains axle weights were known, it would be possible to scale the sensor readings to the show the correct values. This would in theory make the table above show the correct results.

\subsubsection{Calibration of sensors and the program}
\label{calibration}
As seen in section \ref{section:calculating_axle_weights}, a calibration of the sensors is necessary for correct calculations of a trains axle weights. In normal circumstances this could be done in the following manner.
\begin{enumerate}
	\item Have a train, of which the known properties are velocity, axle spacings and axle weights, perform one or more runs in both directions.
	\item The obtained strain signals from these passings are used along with the Influence line to calculate the axle weights for at least one sensor.
	\item The resulting axle weights should have a constant ratio between the same axles for different sensors.
	\item The axle weights are scaled to equal the known values. These scalars is the calibrating constants for the sensors.
	\item The scalars obtained could be used directly on the signal data, but the only part of the BWIM which directly requires this scaling for correct results are the calculated axle weights.
\end{enumerate}
Due to limited field data, the only train which is usable for calibrating the sensors is the freight train. The freight train has one constant which the other trains do not have, a locomotive which will have axle weights approximately equal the given properties of the locomotive as listed in \ref{appendix:el14}. The calibration performed in this project was performed thusly:
\begin{enumerate}
	\item Identify the first 2 major peaks of the signal corresponding to the 6 axles of the locomotive and cut the signal accordingly.
	\item Find the speed of the train as well as possible.
	\item Use the influence line found through the other trains to calculate the axle weights for each sensor.
	\item Find the scalar giving correct results for each sensor.
\end{enumerate}
The strain signal however proved difficult or impossible to cut correctly, due to the length of the locomotive and the width of the influence line the next axle after the locomotive also influenced the signal, which would affect the results. The best suited sensor for this task proved to be the sensor closes to the support on the side towards Trondheim. Figure \ref{figure:calibration} shows the first peaks of the strain signal for this sensor, where the first two major peaks corresponds to the axles of the locomotive. The red circles named first cutting point and first boigie over, shows a possible cut of the signal could be made. The third and fourth major peak indicates axles of the vagons. The two first peaks should ideally have had the same level of magnitude, the fact that they do not shows that the first and second set of axles influence the sensor at the same time. The second point also is raised above the first point, which also is the case for the next peak corresponding to vagon axles. A safe signal could based on this not be found to perform calibration with, as it would provide a error. Therefore this a calibration of the sensors have not been achieved in this project.



This way of calibration is prone to error. The speed of the freight train is unknown, and the methods described in the thesis for obtaining the speed will not work as well as for the other trains, where all the axle spacings are known.
 So if a successful identification of the locomotive's axles could be found in the strain signal for at least one sensor, the system could be calibrated.
However, due to the width of influence around the sensor, there may not be a set of peaks in the strain signal which influenced only by the locomotive's axles. Also, the method used so far to determine the speed has been based on the difference between the strain history produced by calculated influence lines, so determining the speed of the freight train will produce a probable error.
The length of the locomotive from axle 1 to axle 6 is 12.2 meters, and the distance from the locomotive's last axle to the next axle of the train is unknown.
Sources of error are many
\begin{easylist}[itemize]
	& The program does not know the exact axle weights, which are required for an exact influence line.
	& There might be errors in the calculated speed of the influence line. When the speed is wrong the influence line typically gains additional peaks and curves, which could be confused with dynamic effects.
	& The noise levels vary for the different sensors and trains. This difference from train passing to train passing will cause error when smoothing influence lines.
	& There is not enough data gathered to produce a general averaged influence line.
	& Error in the placement of found influence lines, which is a likely cause of error due to filtering.
\end{easylist}
