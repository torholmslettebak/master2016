% !TEX root = main.tex
\chapter{Analysis}

% This chapter will describe how the BWIM system performs. What works? Why? How? etc.
This chapter will analyse the how the developed BWIM system performs, with special emphasis on the influence lines produced by the Matrix method.
Sensor locations are as shown in figure \ref{figure:systemSketch}, and is the source of the naming conventions in the plots in this chapter.
% Lerelva bridge has ben a subject of several phd students at NTNU and because of this there exist a accurate Abaqus model of the bridge. Two other student had master projects similar to mine, and I was lucky enough to "borrow" a influence line from them.
% \begin{figure}[H]
% 	\begin{adjustbox}{center}
% 		\input{tikz/influenceLinesAbaqus.tex}
% 	\end{adjustbox}
% 	\caption{Influence line generated by abaqus}
% 	\label{fig:inflAbaqus}
% \end{figure}
\input{strainAnalysis}
\section{Finding the speed of the train}
The importance of using the correct speed in a BWIM system becomes apparent when calculating influence line for a sensor. A wrongly determined speed will result in what looks like dynamic effects or an oscillating influence line, none of which should appear in a static influence line. If the influence line is known incorrect train velocities will still cause wrongly calculated axle weights. A correctly calculated speed is therefore of utmost importance for Bridge Weigh-in-Motion.
As discussed in theory there are two ways used by existing BWIM systems to find the train's velocity. Both these methods have been implemented and tested, however they contained flaws making them unreliable, or unsuitable for this project.
% \Activate
\begin{easylist}[itemize]
 & The method of peak identification \ref{section:trainSpeed}, is very subjected to noise corrupting location of identified peaks. A train bogie typically consist of axles in pairs or threes, which will all influence the sensors simultaneously creating a major peak containing smaller peaks. In such a case the identification of a single peak can be difficult, and will likely provide faulty calculated velocity. Filtering was also employed by this method without being able to find general values of filtering. The filtering of the signal also distorted the peaks to a degree where the result could be unreliable.
 & The method of phase difference using cross correlation depends on strain signals where the trains velocities are known and the distance between two or more sensors. This method seems to work independently of noise which likely makes it superior to the peak method. This method will however require calibration for each setup of a BWIM system, due to the method needing a system constant depending on the bridge and the sensor placement. The velocity of the trains producing the strain signals in this thesis, was not known or attainable through NSB or Jernbaneverket and therefore this method were not applicable for finding velocities. Calibrating this method has neither been the focus of this thesis.
\end{easylist}
% \Deactivate
These two methods both work very well for a theoretical signal, however when noise and dynamics are introduced as well as more complicated bridge boundary conditions identifying the peaks representing the same axles becomes complex. A method identifying peaks, will have to adapt to each signal because the magnitude of noise and dynamics vary for the different sensors and train passings. Due to this thesis' focus on the matrix method and influence lines, these methods have not been a priority and since correct train velocities are of utmost importance for calculating influence lines.

Since neither of these methods were usable without calibration, an alternative way was developed. This method determined the velocity by recreating the strain signal, like shown in figure \ref{fig:recreated_strains}, for various train velocities and minimizing the difference between measured and recreated signal. It utilizes equation \ref{equation:moses_expanded} and requires constant values of axle weights as well as known axle spacings. The only varying factor is the speed used in each iteration to calculate an influence line. A well suited Matlab function "fminsearch", was used to search for the optimal value of train velocity. "fminsearch finds the minimum of a scalar function of several variables, starting at an initial estimate. This is generally referred to as unconstrained nonlinear optimization \cite{fminsearch}" This method uses brute force, and its time consumption proved high. The accuracy of this method is believed to be good, but there may be more than one solution satisying the criterias of the algorithm.

The velocities of the trains found through this brute force method is shown in table \ref{table:speeds}, and all plots and results produced have been made using these velocities, except for specificly mentioned cases.
\begin{table}[h]
	\centering
	\begin{tabularx}{\textwidth}{ |X|X|X|X|X|X| }
		\hline
		train & 3 & 4 & 5 & 6 & 8 \\
		\hline
		velocity (m/s) & 20.99 & 21.7276	&21.4857 & 16.83 &	20.591465  \\
		\hline
	\end{tabularx}
	\caption{Table of determined train velocities}
	\label{table:speeds}
\end{table}

\input{analysisMatrixMethod}

\section{Using calculated influence lines}
\label{section:using_influence_lines}
The matrix method calculates a influence line vector, which is perfectly suited to that specific strain signal. The signals will however vary from train to train, both in length and magnitude. This means that the influence line for the sensor needs to be adapted to the strain signal.
To perform a standard axle weight calculation, the influence line is required to be correctly aligned with the strain signal.
The first peak of the strain signal, corresponding to the first axle of the train, should occur at the same location as the peak of the influence line which should be precisely at the sensor location.
Identifying the first peak of the strain signal is subject to noise which corrupts any reading of peaks in the raw strain signa. Therefore filtering of noise is needed to correctly identify the signals peaks. A trains axle spacings, as seen in \ref{appendix:nsb92} which is the train type of the measurements, consists of short axle distances of about 2.5 meters. If the axle spacing between two axles are short compared to the bridge, or more specifically short compared to the width of the influence line, they both influence the signal simoultaneously and the peaks corresponding to the two axles thus lies very close to each other. The filtering can therefore not be to hard or soft, which results in problems when trying to automate the procedure of identifying axles.
To correctly align the strain signal and influence line, the matlab code used in this thesis first smooths the strain signal to a degree where the desired number of peaks are identifyable before using matlabs findpeaks \cite{findpeaks} procedure to find the peak locations, like seen in figure \ref{fig:axle_peaks}. This functions finds the local maxima of input vector and have the option of specifying conditions for the maxima.
\begin{figure}[htbp]
	\begin{adjustbox}{center}
		\input{tikz/strains/axlePeaks.tex}
	\end{adjustbox}
	\caption{Axle peaks in strain signal}
	\label{fig:axle_peaks}
\end{figure}
When trying to place the influence line, it was found that axle detection needs to be very accurate for the calculation of axle loads. When using the method described above, with filtering to a degree where 8 peaks are found and to check how those peaks correspond with the known train's axle distances, proved to be accurate in some cases and very wrong in other cases. A wrongly found axle peak could for instance result in negative axle weights, and generally wrong axle weights. A more general method which seems to place the influence better is to filter the signal to a degree where only the major peaks are found. The location of the first such peak should roughly correspond to the centre between closely spaced axles, or a bogie centrum, on a train. Since the trains axles spacings are known, a successfully identified bogie location should place the influence line with a decent accuracy.
\begin{figure}[htbp]
	\centering
	\input{tikz/InfluenceLines/placementOfInfluenceLines.tex}
	\caption{Placement of influence lines, based on bogie peaks in signal. The influence lines shown are scaled to fit strain signal magnitude.}
	\label{fig:placing_influencelines}
\end{figure}

\input{calculatingAxleWeights}
% \subsubsection{Calculate the axle weights}
% The axle weights used to calculate the influence lines are as in table \ref{table:axle_weights}. These are as discussed in chapter method something!!. The system setup described in section \ref{system_setup}, gives us three different locaions for measuring strain and so we have three diffferent influence lines generated by the BWIM program. When calculating the axle weights corresponding to each train, we will then have three different estimates of the axle weights.
%
% \begin{figure}[h]
% 	\begin{subfigure}[t]{0.3\textwidth}
% 		\input{tikz/influenceLines/averagedInfluenceline_sensor1.tex}
% 		\caption{sensor 1}
% 		\label{fig:sensor1}
% 	\end{subfigure}
% 	\begin{subfigure}[t]{0.3\textwidth}
% 		\input{tikz/influenceLines/averagedInfluenceline_sensor2.tex}
% 		\caption{sensor 1}
% 		\label{fig:sensor1}
% 	\end{subfigure}
% 	\begin{subfigure}[t]{0.3\textwidth}
% 		\input{tikz/influenceLines/averagedInfluenceline_sensor3.tex}
% 		\caption{sensor 1}
% 		\label{fig:sensor1}
% 	\end{subfigure}
% 	\caption{averaged filtered influence lines used to calculate axle weights}
% 	\label{averaged_filtered_infl_lines}
% \end{figure}
%
%
% \begin{table}[h]
% 	\centering
% 	\begin{tabularx}{\textwidth}{ |X|X|X|X|X|X|X|X|X| }
% 		\hline
% 		Axle & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\
% 		\hline
% 		Axle weight [\SI{}{\kg}] & 9500 &	9500 & 9500 &	9500 & 14575 & 14575 & 14575 & 14575 \\
% 		\hline
% 	\end{tabularx}
% 	\caption{Table of axle weights used to perform BWIM}
% 	\label{table:axle_weights}
% \end{table}
%
% \begin{table}[h]
% 	\centering
% 	\begin{tabularx}{\textwidth}{@{\extracolsep{\fill} } |X|X|X|X|X|X|X|X|X| }
% 		\hline
% 		Axle & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\
% 		\hline
% 		Train 3: axle weight [\SI{}{\kg}] & 12961 &	2650 & 12627 &	3185 & 19950 & 4529 & 18450 & 4474 \\
% 		\hline
% 		Train 4: axle weight [\SI{}{\kg}] & 11772 &	8569 & 1112 &	8404 & 16646 & 13129 & 15673 & 11894 \\
% 		\hline
% 		Train 6: axle weight [\SI{}{\kg}] & 12861 &	7306 & 12663 &	7717 & 18694 & 11667 & 17822 & 9619 \\
% 		\hline
% 		Train 8: axle weight [\SI{}{\kg}] &  12172 &	8042 & 11774 &	8271 & 17076 & 13411 & 16356 & 11823 \\
% 		\hline
% 	\end{tabularx}
% \end{table}
%
% \begin{table}[h]
% 	\centering
% 	\begin{tabularx}{\textwidth}{@{\extracolsep{\fill} } |X|X|X|X|X|X|X|X|X|X|X|X|X| }
% 		\hline
% 		 & \multicolumn{3}{ |c| }{Train 3} & \multicolumn{3}{ |c| }{Train 4} & \multicolumn{3}{ |c| }{Train 6} & \multicolumn{3}{ |c| }{Train 8}\\
% 		\hline
% 		Axle\textbackslash sensor & 1 & 2 & 3 & 1 & 2 & 3 & 1 & 2 & 3 &  1 & 2 & 3 \\
% 		\hline
% 		1 [\SI{}{\kg}] & 8295 & 5875 & 6654 & 10543 & 7839 & 7212 & 10783 & 8004 &  6933 & 10336 & 7831 & 6869 \\
% 		\hline
% 		2 [\SI{}{\kg}] & 9243 & 6849 & 5614 & 10132 & 7413 & 5727 & 10206 & 7095 & 6691 & 10276 & 7323 & 6128 \\
% 		\hline
% 		3 [\SI{}{\kg}] & 8492 & 6579 & 6947 & 9897 & 8076 & 6810 & 10849 & 8631 & 6731 & 9808 & 8122 & 6452 \\
% 		\hline
% 		4 [\SI{}{\kg}] & 8715 & 6543 & 4546 & 9714 & 6740 & 4984 & 10432 & 7100 & 6136 & 10300 & 7182 & 5729 \\
% 		\hline
% 		car sum [\SI{}{\kg}] & 34745 & 25846 & 23761 & 40286 & 30068 & 24733 & 42270 & 30830 & 26491 & 40720 & 30458 & 25178 \\
% 		\hline
% 		5 [\SI{}{\kg}] & 13072 & 10066 & 10160 & 14897 & 12600 & 10002 & 15304 & 12323 & 9913 & 14015 & 11726 & 9192 \\
% 		\hline
% 		6 [\SI{}{\kg}] & 14405 & 11204 & 9846 & 15188 & 11800 & 9948 & 15921 & 11582 & 11275 & 16679 & 12526 & 11617 \\
% 		\hline
% 		7 [\SI{}{\kg}] & 10936 & 8733 & 9729 & 13860 & 11751 & 10319 & 15118 & 12554 &10376 & 13356 & 11569 & 9490 \\
% 		\hline
% 		8 [\SI{}{\kg}] & 14073 & 10897 & 8877 & 13801 & 10476 & 8624 & 13608 & 9730 & 9401 & 14910 & 11179 & 9878 \\
% 		\hline
% 		Loc sum [\SI{}{\kg}] & 52486  & 40900 & 38612 & 57746 & 46627 & 38893 & 59951 & 46189 & 40965 & 58960 & 47000 & 40177 \\
% 		\hline
% 		tot sum [\SI{}{\kg}] & 87231 & 66746 & 62374 & 98031 & 76695 & 63625 & 102221 & 77019 & 67457 & 99680 & 77457 & 65355 \\
% 		\hline
% 	\end{tabularx}
% \end{table}
%
% As table \ref{table:axleWeights_elongated} shows, there clearly is some error in the calculated axle weights. Especially sensor 2 and 3 which generally gives very low estimates. This trend hold for minimal and extended influence lines as well which means that the sensors have not been calibrated. By looking at the same measurement for a specific axle for one sensor and comparing with the same calculated axle weight for another sensor it is possible to calculate the ratio between them. If this ratio also holds for the other axles, the relationship between sensor 1 and 2 is almost constant which in the authors opinion shows the uncalibrated nature of the sensors.
% If at least one trains axle weights were known, it would be possible to scale the sensor readings to the show the correct values. This would in theory make the table above show the correct results.

\section{Calibration and verification of the system}
\label{calibration}
% THIS CHAPTER MAY NO LONGER BE RELEVANT DUE TO THE SENSORS BEING CALIBRATED..
% PERHAPS INSTEAD DISCUSS HOW GENERAL CALIBRATION AND CONTROL OF INFLUENCE LINES WAS TRIED, BUT BECAUSE OF THE DIFFICULTY OF EXTRACTING THE LOCOMOTIVE OF THE FREIGHT TRAIN. a CALIBRATION AND CONTROL WAS NOT POSSIBLE TO DO.
% As seen in section \ref{section:calculating_axle_weights}, a calibration of the sensors may be necessary for correct calculations of a trains axle weights. In normal circumstances this could be done in the following manner.
% \begin{enumerate}
% 	\item Have a train, of which the known properties are velocity, axle spacings and axle weights, perform one or more runs in both directions.
% 	\item The obtained strain signals from these passings are used along with the Influence line to calculate the axle weights for at least one sensor.
% 	\item The resulting axle weights should have a constant ratio between the same axles for different sensors.
% 	\item The axle weights are scaled to equal the known values. These scalars is the calibrating constants for the sensors.
% 	\item The scalars obtained could be used directly on the signal data, but the only part of the BWIM which directly requires this scaling for correct results are the calculated axle weights.
% \end{enumerate}
% Due to limited field data, the only train which is usable for calibrating the sensors is the freight train.  \ref{appendix:el14}. The calibration performed in this project was performed thusly:
% \begin{enumerate}
% 	\item Identify the first 2 major peaks of the signal corresponding to the 6 axles of the locomotive and cut the signal accordingly.
% 	\item Find the speed of the train as well as possible using the methods descibed in section \ref{section:trainSpeed}.
% 	\item Use the influence line found through the other trains to calculate the axle weights for each sensor.
% 	\item Find the scalar giving correct results for each sensor.
% \end{enumerate}
Attempts was made to aquire a signal able to calibrate and verify the system described by thesis. The freight train has one constant which the other trains do not have, a locomotive which will have axle weights approximately equal the given properties of the locomotive as listed in \ref{trains}. To be able to use the locomotive special attention to the cutting of the strain signal of train 7 \ref{fig:strain_train7} was made. Through the BWIM program it was tried to identify the first 2 major peaks of the signal corresponding to the 6 axles of the locomotive and cut the signal accordingly.
The strain signal however proved difficult or impossible to cut correctly, due to the length of the locomotive and the width of the influence line the next axle after the locomotive also influenced the signal, which would affect the results. The best suited sensor for this task proved to be the sensor closes to the support on the side towards Trondheim. Figure \ref{figure:calibration} shows the first peaks of the strain signal for this sensor, where the first two major peaks corresponds to the axles of the locomotive. The red circles named first cutting point and first boigie over, shows a possible cut of the signal could be made. The third and fourth major peak indicates axles of the vagons. The two first peaks should ideally have had the same level of magnitude, the fact that they do not shows that the first and second set of axles influence the sensor at the same time. The second point also is raised above the first point, which also is the case for the next peak corresponding to vagon axles. A safe signal could based on this not be found to perform calibration with, as it would provide a error. Therefore this a calibration of the sensors have not been achieved in this project.

If this calibration locomotive had been found usable, better estimates of the axles weights of the other trains could have been identified. It would also point to where the errors of the system are the most crucuial.

During the time spent in this thesis, attempts were mad to validate the BWIM Matlab program as well as the resulting influence lines. Due to later discovered bugs in the program causing a systematic error in the averaged influence lines, it was for some time believed that the sensors was uncalibrated. With the correction of this bug it is no longer possible to identify signs of the sensors being uncalibrated. However some time went to investigate how the sensors could be calibrated through the BWIM program. One possible way was to calibrate the sensors based on the resulting axle weights for a known train. This also coincides with how the system best could be validated, by using the identified influence lines to calculate the axle weights of a train with known properties. This would give the actual errors of the calculated influence lines, and perhaps give an insight to what what are dynamic effects in the influence lines.
The following scheme was believed to be able to scale uncalibrated sensors.
\begin{enumerate}
	\item Have a train, of which the known properties are velocity, axle distances and axle weights, perform one or more runs in both directions.
	\item The obtained strain signals from these passings are used along with the Influence line to calculate the axle weights for at least one sensor.
	\item The resulting axle weights should have a constant ratio between the same axles for different sensors.
	\item The axle weights are scaled to equal the known values. These scalars is the calibrating constants for the sensors.
	\item The scalars obtained could be used directly on the signal data, but the only part of the BWIM which directly requires this scaling for correct results are the calculated axle weights.
\end{enumerate}
