% !TEX root = main.tex
\section{Method}

\subsection{Programming a BWIM system}
Describe shortly how the BWIM system have been programmed.
Keywords:
% \begin{itemize}
% \item Beam bridge model
% \item Producing a strain history through influence lines
% \item Finding the speed of the train
% \item Finding Axle distances
% \item Solving system for axle weights
% \end{itemize}
This master project began by learning how a BWIM-system works, and to then create a working model performing BWIM. To not make this a too big project this meant building a simple beam model of a bridge in Matlab, and simulate moving loads crossing it.

A simple flow diagram describing the intial BWIM program:
\begin{figure}[H]
	\centering
	\input{tikz/flow_chart.tex}
\end{figure}


\subsubsection{Producing a strain signal}
Through the theoretical moment influence lines of the beam, a strain signal can be built through the moment-strain relationship, found in equation\ref{equation:moment_strain}, for a given set of axle weights. A simple beam bridge model, as seen in figure \ref{figure:beam_model}, will not recreate a actual bridge strain signal but will be used to create a working BWIM system. The produced strain signal will differ from an actual strain signal mostly because of dynamics, from the train and bridge, and because actual boundary conditions of a bridge will differ from the boundary conditions of a simple beam model. The strain sensors will also produce noise distorting the signal.
To make as good a signal as possible, some effort were placed into recreating the effect mentioned above. To add noise to the signal, white gaussian noise was included in the signal through Matlabs wgn function "http://se.mathworks.com/help/comm/ref/wgn.html".


This strain signal could then be used as a base to build the code for a BWIM system.

\begin{figure}[htpb]
	\begin{tikzpicture}
		\draw[thick] (0,0) to (5,0);
		\node[ledd fast={0}{0}{0}] (ledd) {};
		\node[ledd skyve={5}{0}{0}] (skyveledd) {};
		%\draw[->] (0,1) to {$\scriptstyle g$} (0,.1);
		\node (a) at (1,1.5) {};
		\node (b) at (1,.1) {};
		\draw[-open triangle 90] (a) to node[pos=-.4] {$axle 2$} (b);
		\node (c) at (3.5,1.5) {};
		\node (d) at (3.5,.1) {};
		\draw[-open triangle 90] (c) to node[pos=-.4] {$axle 1$} (d);
		\node (e) at (3.5,1) {};
		\node (f) at (4.5,1) {};
		\draw[-open triangle 90] (e) to node[pos=1.2] {$v$} (f);
		\node (g) at (1,.5) {};
		\node (h) at (3.5,.5) {};
		\draw[open triangle 90-open triangle 90] (g) to node[above] {$axle spacing$} (h);
		%\draw (2.5,0) circle [radius=0.1] {sensor};
		%\node[draw,circle] (s) at (2.5,0){};
		\filldraw
		(2.5,0) circle (2pt) node[align=left,   below] {strain sensor};
	\end{tikzpicture}
	%\captionof{figure}{Beam model for initial BWIM}
	\caption{Beam model for developement}
	\label{figure:beam_model}
\end{figure}

\begin{figure}[htpb]
	\begin{tikzpicture}
		\draw[thick] (0,0) to (10,0);
		\node[ledd fast={0}{0}{0}] (ledd) {};
		\node[ledd skyve={10}{0}{0}] (skyveledd) {};
		% \node[spring={3}{0}{0}] (spring) {};
		% \node[spring={6}{0}{0}] (spring) {};
		%\draw[->] (0,1) to {$\scriptstyle g$} (0,.1);
		\node (a) at (1,1.5) {};
		\node (b) at (1,.1) {};
		\draw[-open triangle 90] (a) to node[pos=-.4] {$axle 2$} (b);
		\node (c) at (3.5,1.5) {};
		\node (d) at (3.5,.1) {};
		\draw[-open triangle 90] (c) to node[pos=-.4] {$axle 1$} (d);
		\node (e) at (3.5,1) {};
		\node (f) at (4.5,1) {};
		\draw[-open triangle 90] (e) to node[pos=1.2] {$v$} (f);
		\node (g) at (1,.5) {};
		\node (h) at (3.5,.5) {};
		\draw[open triangle 90-open triangle 90] (g) to node[above] {$axle spacing$} (h);
		%\draw (2.5,0) circle [radius=0.1] {sensor};
		%\node[draw,circle] (s) at (2.5,0){};
		% \node[ledd fast={2}{0}{0}] (ledd) {};
		% \draw (2,-.75) -- (2.25,-1) -- (1.75,-1.25) -- (2.25,-1.5) -- (1.75,-1.75); % spring""
		\node[ledd spring={2}{0}{0}] (skyveledd) {};
		\node[ledd spring={4}{0}{0}] (skyveledd) {};
		\node[ledd spring={6}{0}{0}] (skyveledd) {};
		\node[ledd spring={8}{0}{0}] (skyveledd) {};
		\filldraw
		(2.5,0) circle (2pt) node[align=left,   below] {strain sensor};
	\end{tikzpicture}
	%\captionof{figure}{Beam model for initial BWIM}
	\caption{A more realistic beam bridge model}
	\label{figure:beam_model_alt}
\end{figure}

\begin{figure}[H]
	\begin{adjustbox}{center}
		\input{tikz/strains/createdStrains.tex}
	\end{adjustbox}
	\caption{Strain signal created through beam model}
	\label{fig:strainCreated}
\end{figure}
\begin{figure}[H]
	\begin{adjustbox}{center}
		\input{tikz/influenceLinesFromCreatedStrain.tex}
	\end{adjustbox}
	\caption{Influence line calculated from created strain}
	\label{fig:inflCreated}
\end{figure}


\subsubsection{Finding the speed of the train}
Two working methods of finding the speed of a passing train were developed:
\begin{itemize}
 \item By identifying peaks in the strain history for two different sensors, representing the same axle. The distance between the two sensors and the time difference between the found peaks should theoretically give a good estimate of the trains velocity.
 \item Through doing cross correlation between two sensors strain history. This involves finding the phase difference, or lag, between the signals. The known distance between the strain gauges should then along with a constant, based on distance between sensors, give a reliable estimate of train velocity. INSERT PLOT OF CORRELATION AND SHOW MATHEMATICAL EQUATION DESCRIBING CROSS CORRELATION.
\end{itemize}
These two methods both work very well for a theoretical signal, however when noise and dynamics are introduced as well as more complicated bridge boundary conditions identifying the peaks representing the same axles becomes complex. A method indentifying peaks, will have to adapt to each signal because the magnitude of noise and dynamics vary for the different sensors and train passings. These difficulties also causes problems for placing the found influence lines, this is discussed in section \ref{}.

The speed of the train passings in this thesis was not attainable from NSB or Jernbaneverket, so the method of correlation will not be usable because of the undetermined constant the method requires.

Since neither of these methods were usable without calibration, an alternative way was developed. This method determined the speed by recreating the strain signal for various train velocities and minimizing the difference between measured and recreated signal. This method uses brute force, and its time consumption proved high. Due to this time consumption the velocities used furter in thesis were only based on reading from the middle sensor.

The importance of using the correct speed in a BWIM system becomes apparent when calculating influence line for a sensor. A wrongly determined speed will result in what looks like dynamic effects or an oscillating influence line, none of which should appear in a static influence line.

\subsection{Finding influence lines}
Describe how influence lines have been found from the given strain history from Lerelva Bridge.
Keywords:
\begin{itemize}
\item Matrix method
\item Optimization
\item Speed
\end{itemize}
\subsubsection{Matrix method}
Describe the matrix method.

\subsubsection{Optimization}
Describe how optimization can be used to find optimal influence lines for the bridge.

\subsection{System setup}
\label{system_setup}
To test the BWIM-program on actual data, we Gunnstein, Daniel set up a BWIM-system to gather strain data from actual train passings. The subject bridge were Lerelva-Bridge in Trondheim, figure \ref{fig:lerelva_bridge}, a typical Norwegian steel railway bridge. Three strain gauges, \SI{3}{\mm} \SI{120}{ohms} from HBM, were placed by the support towards Trondheim on the first section of the longitudinal stringer, see figure \ref{fig:strain_gauges}. The sensors were placed with \SI{1}{\m} spacing around the middle of the stringer section. These strain gauges were connected to a National Instruments compactDAQ with module NI 9235 which produced an continuous data flow to a standard laptop, see figure \ref{fig:instruments}. A Kipor generator was brought for power.
% INSERT SYSTEM IMAGE HERE
\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{figures/system_setup}
		\caption{System setup from data gathering at Lerelva}
		\label{fig:instruments}
	\end{subfigure}
	\begin{subfigure}[t]{0.49\textwidth}
    \centering
    \includegraphics[width=\textwidth]{figures/sensor_placement}
		\caption{Placement of strain gauges on stringer section}
		\label{fig:strain_gauges}
	\end{subfigure}
	\caption{Instruments for aquiring strain data}
	\label{fig:system_setup}
	% \includegraphics[scale=0.5]{figures/inflLinesQuilligan}
\end{figure}
\begin{figure}[H]
	\includegraphics[width=\textwidth]{figures/train_passing.jpg}
	\caption{Lerelva bridge with a train passing over}
	\label{fig:lerelva_bridge}
\end{figure}


\subsection{Testing}
Keywords:
\begin{itemize}
\item Comparing calculated strain with measured strain
\item Perform the same test with a influence line found through the matrix method
\end{itemize}

When performing BWIM with a influence line through the matrix method, the length of the strain signal will require a influence line of a certain length. The exact position where the train begins to influence the bridge is not known due to the special conditions of the Trondheim side support and the dynamic effects in the influence line.
To use the found influence line as correctly as possible, it will be needed to place it in accordance with the provided strain signal.

The best form of testing the matrixmethod and the BWIM system would be to have several runs in both directions using the same known train, or locomotive. This would give the possibility of comparing calculated and known axle weights. This will not be possible due to insufficient data material.


\subsubsection{Using calculated influence lines}
To perform a standard BWIM calculation, the influence line needs to be aligned correctly with the strain signal, otherwise calculated Axle weights will be based on faulty calculations from solving the system

$A = I_m \textbackslash \varepsilon$
(NEEDS TO BE IN THEORY).
The first peak of the strain signal, corresponding to the first axle of the train, should occur at the same location as the peak of the influence line which should be precisely at the strain-gauge/sensor location.
Identifying the first peak of the strain signal is subject to noise which corrupts any reading of peaks in the raw strain signa. Therefore filtering of noise is needed to correctly identify the signals peaks. A trains axle spacings, as seen in \ref{appendix:nsb92} which is the train type of the readings, may consist short spacings. If the axle spacing between two axles are short compared to the bridge, they both influence the signal simoultaneously and the peaks corresponding to the two axles thus lies very close to each other. The filtering can therefore not be to hard or soft, which may result in problems when trying to automate the procedure of identifying axles.
To correctly align the strain signal and influence line, the matlab code used in this thesis first smooths the strain signal to a degree where the desired number of peaks are identifyable before using matlabs findpeaks (REFERENCE THIS) procedure to find the peak locations, like seen in figure \ref{fig:axle_peaks}.
\begin{figure}[htbp]
	\begin{adjustbox}{center}
		\input{tikz/strains/axlePeaks.tex}
	\end{adjustbox}
	\caption{Axle peaks in strain signal}
	\label{fig:axle_peaks}
\end{figure}
\begin{figure}[htbp]
	\begin{adjustbox}{center}
		\includegraphics[width=0.9\textwidth]{figures/strain_vs_influenceline}
	\end{adjustbox}
	\caption{Placement of influence lines, influence line has been scaled.}
	\label{fig:strain_vs_influenceLine}
\end{figure}

When trying to place the influence line, it was found that axle detection needs to be very accurate for the calculation of axle loads. When using the method described above, with filtering to a degree where 8 peaks are found and to check how those peaks correspond with the known train's axle distances, proved to be accurate in some cases and very wrong in other cases. A wrongly found axle peak could for instance result in negative axle weights. A more general method which seems to place the influence better is to filter the signal to a degree where only the major peaks are found. It is believed that this peak is roughly the middle between closely spaced axles, or a bogie, on a train. Since the trains axles spacings are known, a successfully identified bogie location should place the influence line with a decent accuracy.
\begin{figure}[htbp]
	\centering
	\input{tikz/InfluenceLines/placementOfInfluenceLines.tex}
	\caption{Placement of influence lines, based on bogie peaks in signal}
	\label{fig:placing_influencelines}
\end{figure}


(The noise level seem to vary according to sensor location.. Place in theory maybe!!)

\subsection{Calibrating sensors}
The sensors described in system setup have not been calibrated. This would result in wrong end results. For instance, the calculated axle weights for a train would vary from sensor to sensor but the relationship between axle 1 for two different sensors would be approximately constant.
Because of a lack of calibration trains, this calibration of the will not be exact. The only train passing where axle weights could be determined is the locomotive of the freight train \ref{appendix:el14}.
